<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POSE_VISION v2 â€” Record & Playback</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@300;400&display=swap');

  :root {
    --bg: #050a0f;
    --panel: #080f18;
    --panel2: #0a1520;
    --accent: #00e5ff;
    --accent2: #ff3d71;
    --accent3: #39ff14;
    --accent4: #ffb300;
    --text: #c8dce8;
    --dim: #3a5060;
    --border: rgba(0,229,255,0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,229,255,0.012) 2px,rgba(0,229,255,0.012) 4px);
    pointer-events: none;
    z-index: 100;
  }

  header {
    width: 100%;
    padding: 14px 28px;
    display: flex;
    align-items: center;
    gap: 14px;
    border-bottom: 1px solid var(--border);
    background: rgba(5,10,15,0.95);
    backdrop-filter: blur(8px);
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .logo-svg { width: 32px; height: 32px; }
  header h1 { font-size: 1rem; letter-spacing: 0.3em; color: var(--accent); text-transform: uppercase; }
  header h1 span { color: var(--dim); }
  .hbadge {
    font-size: 0.6rem; letter-spacing: 0.18em; padding: 2px 8px;
    border: 1px solid; margin-left: 4px;
  }
  .hbadge.live { color: var(--accent3); border-color: var(--accent3); animation: blink 1.8s step-end infinite; }
  .hbadge.rec  { color: var(--accent2); border-color: var(--accent2); animation: blink 0.7s step-end infinite; }
  .hbadge.play { color: var(--accent4); border-color: var(--accent4); }
  .hbadge.hidden { display: none; }
  @keyframes blink { 50%{opacity:0.2} }

  /* â”€â”€ LAYOUT â”€â”€ */
  main {
    width: 100%;
    max-width: 1200px;
    padding: 20px 16px;
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 16px;
    align-items: start;
  }
  @media (max-width: 800px) {
    main { grid-template-columns: 1fr; }
  }

  /* â”€â”€ VIEWPORT â”€â”€ */
  .viewport-wrap {
    position: relative;
    border: 1px solid var(--border);
    box-shadow: 0 0 40px rgba(0,229,255,0.06);
    background: #000;
    overflow: hidden;
  }
  .corner { position: absolute; width: 20px; height: 20px; z-index: 5; pointer-events: none; }
  .corner.tl { top:0;left:0;  border-top:2px solid var(--accent); border-left:2px solid var(--accent); }
  .corner.tr { top:0;right:0; border-top:2px solid var(--accent); border-right:2px solid var(--accent); }
  .corner.bl { bottom:0;left:0;  border-bottom:2px solid var(--accent); border-left:2px solid var(--accent); }
  .corner.br { bottom:0;right:0; border-bottom:2px solid var(--accent); border-right:2px solid var(--accent); }

  #video { position: absolute; opacity: 0; width: 100%; pointer-events: none; transform: scaleX(-1); }
  #canvas { width: 100%; display: block; transform: scaleX(-1); }

  .placeholder {
    width: 100%; aspect-ratio: 16/9;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
    background: radial-gradient(ellipse at center, #0d1f2d 0%, #050a0f 70%);
    color: var(--dim); font-size: 0.8rem; letter-spacing: 0.1em;
  }

  /* recording overlay bar */
  .rec-bar {
    position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
    background: rgba(255,61,113,0.15); border: 1px solid var(--accent2);
    padding: 4px 16px; font-size: 0.65rem; letter-spacing: 0.2em;
    color: var(--accent2); display: none; z-index: 10;
  }
  .rec-bar.active { display: block; }
  .rec-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); margin-right: 6px; animation: blink 0.6s step-end infinite; }

  /* playback progress bar */
  .play-progress {
    position: absolute; bottom: 0; left: 0; height: 3px;
    background: var(--accent4); transition: width 0.1s linear;
    width: 0%; z-index: 10;
  }

  /* â”€â”€ CONTROLS BELOW CANVAS â”€â”€ */
  .ctrl-row {
    display: flex; gap: 8px; flex-wrap: wrap; padding: 12px 0 0;
  }

  btn-group { display: contents; }

  button {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem; letter-spacing: 0.15em; text-transform: uppercase;
    padding: 8px 18px; border: 1px solid var(--accent);
    background: transparent; color: var(--accent); cursor: pointer;
    transition: all 0.15s; position: relative; overflow: hidden;
    white-space: nowrap;
  }
  button span.ico { margin-right: 5px; }
  button::before {
    content: ''; position: absolute; inset: 0;
    background: var(--accent); transform: translateX(-100%);
    transition: transform 0.15s; z-index: -1;
  }
  button:hover:not(:disabled) { color: var(--bg); }
  button:hover:not(:disabled)::before { transform: translateX(0); }
  button:disabled { border-color: var(--dim); color: var(--dim); cursor: not-allowed; }
  button:disabled::before { display: none; }
  button.red  { border-color: var(--accent2); color: var(--accent2); }
  button.red::before  { background: var(--accent2); }
  button.amber{ border-color: var(--accent4); color: var(--accent4); }
  button.amber::before{ background: var(--accent4); }
  button.green{ border-color: var(--accent3); color: var(--accent3); }
  button.green::before{ background: var(--accent3); }
  button.active-rec { background: rgba(255,61,113,0.2) !important; border-color: var(--accent2) !important; color: var(--accent2) !important; }

  /* â”€â”€ SIDE PANEL â”€â”€ */
  .side-panel {
    display: flex; flex-direction: column; gap: 12px;
  }

  .panel-section {
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 14px;
  }
  .panel-section h3 {
    font-size: 0.62rem; letter-spacing: 0.25em; text-transform: uppercase;
    color: var(--dim); margin-bottom: 12px;
    padding-bottom: 8px; border-bottom: 1px solid rgba(0,229,255,0.08);
  }

  /* stats */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .stat { display: flex; flex-direction: column; gap: 2px; }
  .stat-label { font-size: 0.58rem; letter-spacing: 0.15em; color: var(--dim); text-transform: uppercase; }
  .stat-value { font-size: 1.2rem; color: var(--accent); line-height: 1; }
  .stat-value.g { color: var(--accent3); }
  .stat-value.r { color: var(--accent2); }
  .stat-value.a { color: var(--accent4); }

  /* options */
  .opt-list { display: flex; flex-direction: column; gap: 8px; }
  .opt { display: flex; align-items: center; gap: 8px; font-size: 0.68rem; letter-spacing: 0.08em; cursor: pointer; }
  .opt input[type=checkbox] { accent-color: var(--accent); width: 13px; height: 13px; }
  .opt input[type=range]  { accent-color: var(--accent4); flex: 1; }
  .opt-sep { font-size: 0.58rem; letter-spacing: 0.2em; color: var(--dim); text-transform: uppercase; margin-top: 4px; }

  /* clip list */
  .clip-list { display: flex; flex-direction: column; gap: 6px; max-height: 280px; overflow-y: auto; }
  .clip-list::-webkit-scrollbar { width: 4px; }
  .clip-list::-webkit-scrollbar-track { background: transparent; }
  .clip-list::-webkit-scrollbar-thumb { background: var(--dim); }

  .clip-item {
    display: flex; align-items: center; gap: 6px;
    border: 1px solid rgba(0,229,255,0.1);
    padding: 7px 10px; cursor: pointer; transition: border-color 0.15s;
    background: var(--panel2);
  }
  .clip-item:hover { border-color: var(--accent4); }
  .clip-item.selected { border-color: var(--accent4); background: rgba(255,179,0,0.06); }
  .clip-item.playing  { border-color: var(--accent3); background: rgba(57,255,20,0.05); }
  .clip-color { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .clip-info { flex: 1; min-width: 0; }
  .clip-name { font-size: 0.68rem; letter-spacing: 0.05em; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .clip-meta { font-size: 0.58rem; color: var(--dim); margin-top: 2px; }
  .clip-del { font-size: 0.7rem; color: var(--accent2); cursor: pointer; padding: 2px 4px; opacity: 0.6; }
  .clip-del:hover { opacity: 1; }
  .clip-vis { font-size: 0.65rem; color: var(--dim); cursor: pointer; padding: 2px 4px; }
  .clip-vis.on { color: var(--accent4); }

  .no-clips { font-size: 0.68rem; color: var(--dim); text-align: center; padding: 16px 0; }

  /* playback controls */
  .pb-controls { display: flex; gap: 6px; align-items: center; margin-top: 8px; }
  .pb-controls button { padding: 6px 12px; font-size: 0.68rem; }

  footer { padding: 18px; font-size: 0.58rem; letter-spacing: 0.15em; color: var(--dim); text-align: center; }
</style>
</head>
<body>

<header>
  <svg class="logo-svg" viewBox="0 0 32 32" fill="none">
    <circle cx="16" cy="6" r="3" stroke="#00e5ff" stroke-width="1.5"/>
    <line x1="16" y1="9" x2="16" y2="19" stroke="#00e5ff" stroke-width="1.5"/>
    <line x1="16" y1="14" x2="9" y2="19" stroke="#00e5ff" stroke-width="1.5"/>
    <line x1="16" y1="14" x2="23" y2="19" stroke="#00e5ff" stroke-width="1.5"/>
    <line x1="16" y1="19" x2="12" y2="28" stroke="#00e5ff" stroke-width="1.5"/>
    <line x1="16" y1="19" x2="20" y2="28" stroke="#00e5ff" stroke-width="1.5"/>
  </svg>
  <h1>POSE<span>_</span>VISION <span style="font-size:0.7em;color:var(--dim)">v2</span></h1>
  <div class="hbadge live" id="badge-live">LIVE</div>
  <div class="hbadge rec hidden" id="badge-rec">â— REC</div>
  <div class="hbadge play hidden" id="badge-play">â–¶ PLAY</div>
</header>

<main>
  <!-- LEFT: viewport + controls -->
  <div>
    <div class="viewport-wrap" id="viewport">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
      <div class="placeholder" id="placeholder">
        <svg width="56" height="56" viewBox="0 0 56 56" fill="none">
          <circle cx="28" cy="11" r="5" stroke="#3a5060" stroke-width="1.8"/>
          <line x1="28" y1="16" x2="28" y2="32" stroke="#3a5060" stroke-width="1.8"/>
          <line x1="28" y1="23" x2="18" y2="30" stroke="#3a5060" stroke-width="1.8"/>
          <line x1="28" y1="23" x2="38" y2="30" stroke="#3a5060" stroke-width="1.8"/>
          <line x1="28" y1="32" x2="22" y2="46" stroke="#3a5060" stroke-width="1.8"/>
          <line x1="28" y1="32" x2="34" y2="46" stroke="#3a5060" stroke-width="1.8"/>
        </svg>
        <div>ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦å§¿å‹¢æ¨å®šã‚’é–‹å§‹</div>
      </div>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="rec-bar" id="rec-bar"><span class="rec-dot"></span> REC â€” <span id="rec-dur">0.0s</span> / <span id="rec-frames">0f</span></div>
      <div class="play-progress" id="play-progress"></div>
    </div>

    <div class="ctrl-row">
      <button id="btnCamera" onclick="startCamera()"><span class="ico">â–¶</span>ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
      <button id="btnStop" class="red" onclick="stopCamera()" disabled><span class="ico">â– </span>åœæ­¢</button>
      <button id="btnRec" class="red" onclick="toggleRecord()" disabled><span class="ico">â—</span>éŒ²ç”»</button>
      <button id="btnPlay" class="amber" onclick="playSelected()" disabled><span class="ico">â–¶</span>å†ç”Ÿ</button>
      <button id="btnStopPlay" class="green" onclick="stopPlayback()" disabled><span class="ico">â– </span>å†ç”Ÿåœæ­¢</button>
    </div>
  </div>

  <!-- RIGHT: side panel -->
  <div class="side-panel">

    <!-- Stats -->
    <div class="panel-section">
      <h3>// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
      <div class="stats-grid">
        <div class="stat"><div class="stat-label">FPS</div><div class="stat-value" id="fps-val">--</div></div>
        <div class="stat"><div class="stat-label">æ¤œå‡ºäººæ•°</div><div class="stat-value g" id="persons-val">0</div></div>
        <div class="stat"><div class="stat-label">éŒ²ç”»ãƒ•ãƒ¬ãƒ¼ãƒ </div><div class="stat-value r" id="rec-count">--</div></div>
        <div class="stat"><div class="stat-label">å†ç”Ÿä½ç½®</div><div class="stat-value a" id="play-pos">--</div></div>
      </div>
    </div>

    <!-- Display options -->
    <div class="panel-section">
      <h3>// è¡¨ç¤ºè¨­å®š</h3>
      <div class="opt-list">
        <div class="opt-sep">ãƒ©ã‚¤ãƒ–</div>
        <label class="opt"><input type="checkbox" id="showVideo" checked> ã‚«ãƒ¡ãƒ©æ˜ åƒ</label>
        <label class="opt"><input type="checkbox" id="showSkeleton" checked> ã‚¹ã‚±ãƒ«ãƒˆãƒ³</label>
        <label class="opt"><input type="checkbox" id="showLandmarks" checked> ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯</label>
        <label class="opt"><input type="checkbox" id="showConf"> ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢</label>
        <div class="opt-sep">éŒ²ç”»æ¸ˆã¿ã‚¯ãƒªãƒƒãƒ—</div>
        <label class="opt"><input type="checkbox" id="showGhost" checked> ã‚´ãƒ¼ã‚¹ãƒˆï¼ˆå…¨ã‚¯ãƒªãƒƒãƒ—ï¼‰</label>
        <label class="opt">ã‚´ãƒ¼ã‚¹ãƒˆä¸é€æ˜åº¦
          <input type="range" id="ghostAlpha" min="10" max="100" value="60" style="width:80px">
        </label>
        <label class="opt"><input type="checkbox" id="loopPlay" checked> ãƒ«ãƒ¼ãƒ—å†ç”Ÿ</label>
      </div>
    </div>

    <!-- Clip manager -->
    <div class="panel-section">
      <h3>// ã‚¯ãƒªãƒƒãƒ—ç®¡ç† <span id="clip-count" style="color:var(--accent4)">[0]</span></h3>
      <div class="clip-list" id="clip-list">
        <div class="no-clips" id="no-clips">éŒ²ç”»ã‚¯ãƒªãƒƒãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“</div>
      </div>
      <div class="pb-controls">
        <button class="amber" onclick="playSelected()" id="pbPlay" disabled><span>â–¶</span> å†ç”Ÿ</button>
        <button onclick="stopPlayback()" id="pbStop" disabled>â–  åœæ­¢</button>
        <button class="red" onclick="deleteSelected()" id="pbDel" disabled>âœ• å‰Šé™¤</button>
      </div>
    </div>

  </div>
</main>

<footer>POSE_VISION v2 â€” MediaPipe Pose Landmarker + Record & Playback Overlay</footer>

<script type="module">
import { PoseLandmarker, FilesetResolver } from
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONSTANTS & STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CONNECTIONS = [
  [0,1],[1,2],[2,3],[3,7],[0,4],[4,5],[5,6],[6,8],[9,10],
  [11,12],[11,23],[12,24],[23,24],
  [11,13],[13,15],[15,17],[15,19],[15,21],[17,19],
  [12,14],[14,16],[16,18],[16,20],[16,22],[18,20],
  [23,25],[25,27],[27,29],[27,31],[29,31],
  [24,26],[26,28],[28,30],[28,32],[30,32],
];

const LEFT_IDX  = new Set([11,13,15,17,19,21,23,25,27,29,31,1,2,3,7]);
const RIGHT_IDX = new Set([12,14,16,18,20,22,24,26,28,30,32,4,5,6,8]);

// Clip color palette
const CLIP_COLORS = ['#ff3d71','#ffb300','#c471ed','#12c2e9','#f64f59','#43e97b','#fa709a','#fee140'];

const video    = document.getElementById('video');
const canvas   = document.getElementById('canvas');
const ctx      = canvas.getContext('2d');

let poseLandmarker = null;
let animId = null;
let stream = null;
let frameCount = 0, fpsTimer = 0, fps = 0;

// Recording state
let isRecording  = false;
let recStartTime = 0;
let recBuffer    = [];   // [{t, poses:[{x,y,z,visibility}[]]}]
let recDurTimer  = null;

// Clips store
let clips = [];          // [{id, name, color, frames, duration, visible}]
let selectedClipId = null;

// Playback state (supports multiple simultaneous ghost clips + one "active" playing clip)
let playState = null;
// playState = { clipId, startWall, looping }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MEDIAPIPE INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function initPoseLandmarker() {
  setStatus('ãƒ¢ãƒ‡ãƒ«èª­è¾¼ä¸­...');
  const fr = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12/wasm");
  poseLandmarker = await PoseLandmarker.createFromOptions(fr, {
    baseOptions: {
      modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
      delegate: "GPU"
    },
    runningMode: "VIDEO",
    numPoses: 2,
    minPoseDetectionConfidence: 0.5,
    minPosePresenceConfidence: 0.5,
    minTrackingConfidence: 0.5,
  });
  setStatus('æº–å‚™å®Œäº†');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CAMERA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.startCamera = async function() {
  try {
    setStatus('ã‚«ãƒ¡ãƒ©å–å¾—ä¸­...');
    stream = await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720}});
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    document.getElementById('placeholder').style.display = 'none';

    if (!poseLandmarker) await initPoseLandmarker();
    document.getElementById('btnCamera').disabled = true;
    document.getElementById('btnStop').disabled   = false;
    document.getElementById('btnRec').disabled    = false;
    setStatus('æ¨å®šä¸­');
    renderLoop();
  } catch(e) {
    setStatus('ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
};

window.stopCamera = function() {
  if (isRecording) stopRecord();
  stopPlayback();
  cancelAnimationFrame(animId);
  stream?.getTracks().forEach(t => t.stop());
  ctx.clearRect(0,0,canvas.width,canvas.height);
  document.getElementById('placeholder').style.display = 'flex';
  document.getElementById('btnCamera').disabled = false;
  document.getElementById('btnStop').disabled   = true;
  document.getElementById('btnRec').disabled    = true;
  document.getElementById('fps-val').textContent     = '--';
  document.getElementById('persons-val').textContent = '0';
  setStatus('å¾…æ©Ÿä¸­');
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RECORDING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.toggleRecord = function() {
  isRecording ? stopRecord() : startRecord();
};

function startRecord() {
  if (isRecording) return;
  isRecording = true;
  recBuffer = [];
  recStartTime = performance.now();

  document.getElementById('rec-bar').classList.add('active');
  document.getElementById('badge-rec').classList.remove('hidden');
  document.getElementById('btnRec').textContent  = 'â–  éŒ²ç”»åœæ­¢';
  document.getElementById('btnRec').classList.add('active-rec');

  recDurTimer = setInterval(() => {
    const s = ((performance.now() - recStartTime) / 1000).toFixed(1);
    document.getElementById('rec-dur').textContent = s + 's';
    document.getElementById('rec-frames').textContent = recBuffer.length + 'f';
    document.getElementById('rec-count').textContent = recBuffer.length;
  }, 100);
}

function stopRecord() {
  if (!isRecording) return;
  isRecording = false;
  clearInterval(recDurTimer);

  document.getElementById('rec-bar').classList.remove('active');
  document.getElementById('badge-rec').classList.add('hidden');
  document.getElementById('btnRec').innerHTML = '<span class="ico">â—</span>éŒ²ç”»';
  document.getElementById('btnRec').classList.remove('active-rec');

  if (recBuffer.length < 2) return; // discard too-short recordings

  const id  = Date.now();
  const dur = (recBuffer[recBuffer.length-1].t - recBuffer[0].t);
  const clip = {
    id, name: `Clip ${clips.length+1}`,
    color: CLIP_COLORS[clips.length % CLIP_COLORS.length],
    frames: recBuffer.slice(), duration: dur,
    visible: true
  };
  clips.push(clip);
  selectedClipId = id;
  recBuffer = [];
  refreshClipList();
  updatePlayButtons();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PLAYBACK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.playSelected = function() {
  const clip = clips.find(c => c.id === selectedClipId);
  if (!clip) return;
  playState = {
    clipId: selectedClipId,
    startWall: performance.now(),
  };
  document.getElementById('badge-play').classList.remove('hidden');
  document.getElementById('btnStopPlay').disabled = false;
  document.getElementById('pbStop').disabled = false;
};

window.stopPlayback = function() {
  playState = null;
  document.getElementById('badge-play').classList.add('hidden');
  document.getElementById('btnStopPlay').disabled = true;
  document.getElementById('pbStop').disabled      = true;
  document.getElementById('play-progress').style.width = '0%';
  document.getElementById('play-pos').textContent = '--';
  refreshClipList();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CLIP MANAGEMENT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.deleteSelected = function() {
  if (!selectedClipId) return;
  if (playState?.clipId === selectedClipId) stopPlayback();
  clips = clips.filter(c => c.id !== selectedClipId);
  selectedClipId = clips.length ? clips[clips.length-1].id : null;
  refreshClipList();
  updatePlayButtons();
};

function refreshClipList() {
  const list = document.getElementById('clip-list');
  const noClips = document.getElementById('no-clips');
  document.getElementById('clip-count').textContent = `[${clips.length}]`;

  if (!clips.length) {
    list.innerHTML = '';
    list.appendChild(noClips);
    noClips.style.display = 'block';
    return;
  }
  noClips.style.display = 'none';
  list.innerHTML = '';

  clips.forEach(clip => {
    const isSelected = clip.id === selectedClipId;
    const isPlaying  = playState?.clipId === clip.id;
    const dur = (clip.duration / 1000).toFixed(1);
    const frames = clip.frames.length;

    const el = document.createElement('div');
    el.className = 'clip-item' + (isSelected?' selected':'') + (isPlaying?' playing':'');
    el.innerHTML = `
      <div class="clip-color" style="background:${clip.color}"></div>
      <div class="clip-info">
        <div class="clip-name">${clip.name}</div>
        <div class="clip-meta">${dur}s Â· ${frames}f Â· ${clip.frames[0]?.poses?.length??0}äºº</div>
      </div>
      <span class="clip-vis ${clip.visible?'on':''}" title="è¡¨ç¤º/éè¡¨ç¤º">ğŸ‘</span>
      <span class="clip-del" title="å‰Šé™¤">âœ•</span>`;

    el.addEventListener('click', (e) => {
      if (e.target.classList.contains('clip-del')) {
        if (playState?.clipId === clip.id) stopPlayback();
        clips = clips.filter(c => c.id !== clip.id);
        if (selectedClipId === clip.id) selectedClipId = clips.length ? clips[clips.length-1].id : null;
        refreshClipList(); updatePlayButtons(); return;
      }
      if (e.target.classList.contains('clip-vis')) {
        clip.visible = !clip.visible;
        e.target.className = 'clip-vis ' + (clip.visible?'on':'');
        return;
      }
      selectedClipId = clip.id;
      refreshClipList(); updatePlayButtons();
    });
    list.appendChild(el);
  });
}

function updatePlayButtons() {
  const has = !!selectedClipId;
  document.getElementById('btnPlay').disabled  = !has;
  document.getElementById('pbPlay').disabled   = !has;
  document.getElementById('pbDel').disabled    = !has;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER LOOP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderLoop() {
  const now = performance.now();

  // â”€â”€ Live pose detection â”€â”€
  let liveResults = null;
  if (poseLandmarker && video.readyState >= 2) {
    liveResults = poseLandmarker.detectForVideo(video, now);
  }

  // â”€â”€ Record frame â”€â”€
  if (isRecording && liveResults?.landmarks?.length) {
    recBuffer.push({
      t: now - recStartTime,
      poses: liveResults.landmarks.map(lm =>
        lm.map(p => ({ x: p.x, y: p.y, z: p.z, visibility: p.visibility }))
      )
    });
  }

  // â”€â”€ Background â”€â”€
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (document.getElementById('showVideo').checked) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
  } else {
    ctx.fillStyle = '#050a0f';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    // grid
    ctx.strokeStyle = 'rgba(0,229,255,0.03)'; ctx.lineWidth = 1;
    for (let x=0;x<canvas.width;x+=40){ ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke(); }
    for (let y=0;y<canvas.height;y+=40){ ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke(); }
  }

  // â”€â”€ Ghost: draw all visible clips (passive looping) â”€â”€
  const ghostAlpha = parseInt(document.getElementById('ghostAlpha').value) / 100;
  const showGhost  = document.getElementById('showGhost').checked;

  if (showGhost) {
    clips.forEach(clip => {
      if (!clip.visible) return;
      // interpolate ghost position based on wall clock (auto-loop)
      const elapsed = (now % (clip.duration + 500)); // 500ms gap
      const frame = getFrameAtTime(clip, elapsed);
      if (frame) {
        frame.poses.forEach(pose => {
          drawPose(pose, clip.color, ghostAlpha * 0.55, 2, false);
        });
      }
    });
  }

  // â”€â”€ Active playback â”€â”€
  if (playState) {
    const clip = clips.find(c => c.id === playState.clipId);
    if (clip) {
      const elapsed  = now - playState.startWall;
      const looping  = document.getElementById('loopPlay').checked;
      let   playTime = elapsed;

      if (playTime > clip.duration) {
        if (looping) {
          playState.startWall = now - (elapsed % clip.duration);
          playTime = elapsed % clip.duration;
        } else {
          stopPlayback();
        }
      }

      if (playState) {
        const frame = getFrameAtTime(clip, playTime);
        if (frame) {
          frame.poses.forEach(pose => {
            drawPose(pose, clip.color, ghostAlpha, 3.5, true);
          });
        }
        const pct = Math.min(playTime / clip.duration * 100, 100).toFixed(1);
        document.getElementById('play-progress').style.width = pct + '%';
        document.getElementById('play-pos').textContent = (playTime/1000).toFixed(1)+'s';
      }
    } else { stopPlayback(); }
  }

  // â”€â”€ Live skeleton â”€â”€
  if (liveResults?.landmarks) {
    document.getElementById('persons-val').textContent = liveResults.landmarks.length;
    liveResults.landmarks.forEach(pose => {
      drawLivePose(pose);
    });
  } else {
    document.getElementById('persons-val').textContent = '0';
  }

  // â”€â”€ FPS â”€â”€
  frameCount++;
  if (now - fpsTimer >= 500) {
    fps = Math.round(frameCount * 1000 / (now - fpsTimer));
    document.getElementById('fps-val').textContent = fps;
    frameCount = 0; fpsTimer = now;
  }

  animId = requestAnimationFrame(renderLoop);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DRAWING HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getBoneColor(i, j, live) {
  if (!live) return null; // caller provides color
  if (LEFT_IDX.has(i) && LEFT_IDX.has(j))   return '#39ff14';
  if (RIGHT_IDX.has(i) && RIGHT_IDX.has(j)) return '#ff3d71';
  return '#00e5ff';
}

function drawLivePose(landmarks) {
  const showSkel = document.getElementById('showSkeleton').checked;
  const showLm   = document.getElementById('showLandmarks').checked;
  const showConf = document.getElementById('showConf').checked;

  if (showSkel) {
    for (const [i,j] of CONNECTIONS) {
      const a = landmarks[i], b = landmarks[j];
      if (!a||!b||a.visibility<0.3||b.visibility<0.3) continue;
      const color = getBoneColor(i,j,true);
      drawBone(a.x*canvas.width, a.y*canvas.height,
               b.x*canvas.width, b.y*canvas.height,
               color, Math.min(a.visibility,b.visibility), 3, 14);
    }
  }
  if (showLm) {
    landmarks.forEach((lm,i) => {
      if (!lm||lm.visibility<0.3) return;
      drawJoint(lm.x*canvas.width, lm.y*canvas.height, '#ffffff', lm.visibility, 4, 16);
      if (showConf) {
        ctx.save();
        ctx.font = '10px Share Tech Mono, monospace';
        ctx.fillStyle = '#00e5ff'; ctx.globalAlpha = 0.7;
        ctx.fillText((lm.visibility*100).toFixed(0)+'%',
          lm.x*canvas.width+6, lm.y*canvas.height-4);
        ctx.restore();
      }
    });
  }
}

function drawPose(landmarks, color, alpha, lineW, glowStrong) {
  for (const [i,j] of CONNECTIONS) {
    const a = landmarks[i], b = landmarks[j];
    if (!a||!b||a.visibility<0.25||b.visibility<0.25) continue;
    const vis = Math.min(a.visibility,b.visibility);
    drawBone(a.x*canvas.width, a.y*canvas.height,
             b.x*canvas.width, b.y*canvas.height,
             color, vis * alpha, lineW, glowStrong ? 18 : 8);
  }
  landmarks.forEach(lm => {
    if (!lm||lm.visibility<0.25) return;
    drawJoint(lm.x*canvas.width, lm.y*canvas.height, color, lm.visibility*alpha, 3.5, glowStrong?12:6);
  });
}

function drawBone(x1,y1,x2,y2,color,alpha,lw,blur) {
  ctx.save();
  ctx.globalAlpha = Math.min(alpha,1);
  ctx.strokeStyle = color;
  ctx.lineWidth   = lw;
  ctx.shadowColor = color;
  ctx.shadowBlur  = blur;
  ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  ctx.restore();
}

function drawJoint(x,y,color,alpha,r,blur) {
  ctx.save();
  ctx.globalAlpha = Math.min(alpha,1);
  ctx.fillStyle   = color;
  ctx.shadowColor = color;
  ctx.shadowBlur  = blur;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FRAME INTERPOLATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getFrameAtTime(clip, elapsedMs) {
  if (!clip.frames.length) return null;
  const frames = clip.frames;
  // binary search for closest frame
  let lo = 0, hi = frames.length - 1;
  while (lo < hi) {
    const mid = (lo + hi) >> 1;
    if (frames[mid].t < elapsedMs) lo = mid + 1;
    else hi = mid;
  }
  if (lo === 0) return frames[0];
  const f0 = frames[lo-1], f1 = frames[lo];
  const range = f1.t - f0.t;
  if (range < 1) return f0;
  const t = (elapsedMs - f0.t) / range; // 0..1

  // Interpolate each pose
  const numPoses = Math.min(f0.poses.length, f1.poses.length);
  const poses = [];
  for (let p = 0; p < numPoses; p++) {
    const lm0 = f0.poses[p], lm1 = f1.poses[p];
    if (!lm0||!lm1) continue;
    const lerped = lm0.map((a,i) => {
      const b = lm1[i];
      return {
        x: a.x + (b.x - a.x) * t,
        y: a.y + (b.y - a.y) * t,
        z: a.z + (b.z - a.z) * t,
        visibility: a.visibility + (b.visibility - a.visibility) * t,
      };
    });
    poses.push(lerped);
  }
  return { t: elapsedMs, poses };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function setStatus(s) {
  // just log it; we don't have a dedicated status element here
  console.log('[STATUS]', s);
}

// init
initPoseLandmarker().catch(console.error);
refreshClipList();
</script>
</body>
</html>
